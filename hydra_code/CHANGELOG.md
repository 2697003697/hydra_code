# Changelog

所有重要变更将在此文件中记录。

## [0.3.1] - 2026-02-20

### 修复

#### 1. config.py role_configs 问题修复
- **现象**: 当配置文件中没有定义 roles 时，向 Config 构造函数传递 None 而非空字典
- **原因**: parse_config 函数中使用了 `role_configs if role_configs else None` 表达式
- **修复**: 简化为直接传递 `role_configs`，Config.__post_init__ 会正确处理空字典情况

#### 2. parallel.py 重复导入清理
- **现象**: 文件中存在重复的 `from rich.live import Live` 导入
- **修复**: 删除了重复的导入语句，保持代码整洁
#### 3. config.py 示例中单个模型未添加max_tokens 问题修复
- **现象**: 示例配置文件中单个模型未添加 max_tokens 字段，用户可能无法意识到能够设置该参数
- **修复**: 在示例配置文件中为单个模型添加 max_tokens 字段，默认值设为 4096

## [0.3.0] - 2026-02-20

### 修复

#### 1. 消息顺序问题修复
- **现象**: `get_context_for_model` 获取的消息顺序混乱
- **原因**: 使用 `reversed()` 遍历消息时，插入逻辑有误
- **修复**: 重构遍历逻辑，确保消息按时间正序排列（最旧的消息在前，最新的在后），符合模型上下文要求

#### 2. 压缩判断逻辑问题修复
- **现象**: 即使 Token 数超标，如果消息条数未超标，也不会触发压缩
- **原因**: 判断条件逻辑错误，需同时满足两个条件才压缩
- **修复**: 将判断逻辑改为"消息数量超标 **或** Token 数量超标"即触发压缩

#### 3. 重要性覆盖问题修复
- **现象**: 用户手动指定的消息 `importance` 参数被系统默认值覆盖
- **修复**: 添加条件判断，仅当 `importance` 为 0（默认值）时才应用系统自动评分逻辑，保留用户手动设置的高优先级

#### 4. 正则提取 Bug 修复
- **现象**: `_extract_key_info` 无法正确提取文件名，例如输入"我创建了文件 test.py"，系统错误地提取为 ['创建了文']
- **原因**: 正则表达式 `r'创建[了]?\s*[文件|项目|模块]'` 缺少对文件名的捕获组
- **修复**: 更新了 `create_patterns` 和 `modify_patterns`，增加了对文件名的捕获组（如 `([a-zA-Z0-9_\-\./\\]+\.[a-zA-Z0-9]+)`），现在能正确提取文件名

#### 5. 工具调用原子性保护
- **现象**: 当对话历史过长触发 `max_tokens` 限制时，截断点可能发生在 Assistant 调用工具和工具返回结果之间，导致工具返回结果保留但调用消息被丢弃，造成发送给模型的上下文以 tool 消息开头，违反 LLM API 协议，引发 422 Invalid tool protocol 错误
- **修复**: 在 `get_context_for_model` 方法中加入原子性保护逻辑：
  - 软限制保护: 遍历消息时，如果即将因为 Token 超限停止，且当前上下文第一条消息是 tool 类型，系统会检查即将丢弃的消息是否是发起该调用的 assistant 消息，如是则强制包含
  - 安全清理: 在构建最终上下文前，移除以 tool 消息开头的孤儿工具消息

## [0.2.0] - 之前版本

### 特性
- 初始版本发布
